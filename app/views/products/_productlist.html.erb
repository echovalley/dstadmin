<aside class="ad_left">
<h4 class="icon_product">产 品
  <%= link_to '(+添加新产品)', new_product_path, :remote => true %>
  <%= link_to '(刷新)', products_path, :remote => true %>
  <i><em><%= @spotted_number %></em>/<%= @total_number %></i>
  </h4>
  <div class="quick_search bg_green relative">
    <%= form_tag(search_products_path, :remote => true, :method => 'get') do %>
    <label>名称/品牌搜索：</label>
    <%= select_tag :status, options_for_select({'全部状态' => -1, '正常状态' => 1, '暂停状态' => 2}, @status.blank? ? -1 : @status) %> 
    <%= text_field_tag 'keyword', @keyword.blank? ? '' : @keyword %>
    <%= link_to_function '', '$(this).closest("form").submit()', :class => 'icon_search absolute' %>
    <% end %>
  </div>
  <%= form_tag('', :remote => true, :id => 'frmPdcts') do %>
  <table class="table_data1">
    <thead>
      <tr>
        <th class="checkbox_list"></th>
        <th class="width1">产品</th>
        <th>关联</th>
        <th>修改时间</th>
        <th>状态</th>
      </tr>
    </thead>
    <tbody>
    <% if @products.blank? %>
      <tr>
        <td colspan=5 style='height:100px;font-size:16px'>找不到 :( <br/>
          <%= link_to '新建一个？', new_product_path, :remote => true %>
        </td>
      </tr>
    <% else %>
      <% @products.each do |p| %>
      <tr>
        <td class="checkbox_list"><%= check_box_tag 'pid[]', p.id %></td>
        <td><%= link_to p.pname, p, :remote => true %></td>
        <td>368</td>
        <td><%= p.updated_at.to_s(:db) %></td>
        <td><%= product_status(p.status) %></td>
      </tr>
      <% end %>
    <% end %>
    </tbody>
  </table>
  <div class="bg_gray tablenav">
    <input id="chxAll" name="chxAll" type="checkbox" />
    <%= select_tag 'operation', options_for_select({'删除' => 1, '修改状态' => 2, '设置标签' => 3}, 1), :id => 'opmode' %> 
    <!--select> <option>修改状态 </option> <option>设置标签 </option> <option>删 除 </option> </select-->
    <%= button_tag '执 行', :type => 'button', :remote => true, :class => 'btn_green size-m', :id => 'btnBatchExecute' %>
    <%#= will_paginate @products, :renderer => PaginationListLinkRenderer, :class => 'pagination pagenavi'%>
    <%= will_paginate @products, :class => 'pagination pagenavi', :previous_label => '上一页', :next_label => '下一页' %>
  </div>
  <% end %>
  
</aside>

<div class="modal hide" id="set_status_modal">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>更新产品状态</h3>
  </div>
  <div class="modal-body">
    <input type="radio" id="rdStatus" name="rdStatus" value=1 checked />正常
    <input type="radio" id="rdStatus" name="rdStatus" value=2 />暂停
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">关 闭</a>
    <a href="#" id="btnChangeStatus" class="btn btn-primary">修 改</a>
  </div>
</div>

<div class="modal hide" id="set_tags_modal">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>修改标签</h3>
  </div>
  <div class="modal-body">
    <label>标签：</label>
    <%= text_field_tag 'tags', '' %>
    <%= form_notice('请精确输入产品的标签(多个标签用空格隔开)，以便我们精确匹配图片') %>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">关 闭</a>
    <a href="#" id="btnChangeTags" class="btn btn-primary">修 改</a>
  </div>
</div>

<script type='text/javascript'>
  $('#btnBatchExecute').click(function() {
    var n = $(':checkbox:checked').length;
    if (n == 0) {
      alert ('请选择至少一个产品');
      return false;
    }
    var opmode = $('#opmode').val();
    var form = $('#frmPdcts');
    if (opmode == 1) {
      form.attr('action', '/products/batch_destroy');
      if (window.confirm('确定要删除这些产品吗？（相关报表也会同时删除）')) {
        form.submit();
      }
    } else if (opmode == 2) {
      $('#set_status_modal').modal({show: true, keyboard: true, backdrop: 'static'});

      $('#btnChangeStatus').unbind('click');
      $('#btnChangeStatus').click(function() {
        var status = $("#rdStatus:checked").val();
        form.attr('action', '/products/batch_update_status?status=' + status);
        form.submit();
        $('#set_status_modal').modal('hide');
      });
    } else if (opmode == 3) {
      $('#set_tags_modal').modal({show: true, keyboard: true, backdrop: 'static'});

      $('#btnChangeTags').unbind('click');
      $('#btnChangeTags').click(function() {
        var tags = $("#tags").val();
        form.attr('action', '/products/batch_update_tags?tags=' + encodeURIComponent(tags));
        form.submit();
        $('#set_tags_modal').modal('hide');
      });
    } else {

    }
  });

  $('#chxAll').click(function() {
    if ($(this).attr('checked')) {
      $('#frmPdcts :input[:type="checkbox"]').attr('checked', true);
    } else {
      $('#frmPdcts :input[:type="checkbox"]').attr('checked', false);
    }
  });

</script>
